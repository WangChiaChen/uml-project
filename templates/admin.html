<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° - Road Justice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .tab-active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            font-weight: bold;
        }

        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #6b7280;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <nav class="bg-white border-b border-gray-200 px-4 py-3 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h1 class="font-bold text-lg text-gray-800">ç³»çµ±ç®¡ç†å¾Œå°</h1>
        </div>
        <a href="/" class="text-sm font-medium text-gray-500 hover:text-blue-600">
            <i class="fas fa-arrow-left mr-1"></i> å›é¦–é 
        </a>
    </nav>

    <div class="container mx-auto max-w-4xl p-4">

        <div class="flex border-b border-gray-200 mb-6">
            <button onclick="switchTab('reports')" id="btn-reports"
                class="flex-1 py-3 text-center transition-colors tab-active">
                <i class="fas fa-clipboard-list mr-2"></i>å¾…å¯©æ ¸æ¡ˆä»¶
            </button>
            <button onclick="switchTab('history')" id="btn-history"
                class="flex-1 py-3 text-center transition-colors tab-inactive">
                <i class="fas fa-star mr-2"></i>æ­·å²èˆ‡è©•åƒ¹
            </button>
            <button onclick="switchTab('users')" id="btn-users"
                class="flex-1 py-3 text-center transition-colors tab-inactive">
                <i class="fas fa-users-cog mr-2"></i>å¸³è™Ÿç®¡ç†
            </button>
        </div>

        <div id="view-reports" class="block">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-700">æ¡ˆä»¶åˆ—è¡¨</h2>
                <button onclick="loadReports()" class="text-blue-600 hover:text-blue-800 text-sm font-medium"><i
                        class="fas fa-sync mr-1"></i> é‡æ–°æ•´ç†</button>
            </div>
            <div id="adminList" class="space-y-4">
                <div class="text-center py-10 text-gray-400">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div id="view-history" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-700">å·²çµæ¡ˆèˆ‡è©•åƒ¹</h2>
                <button onclick="loadHistory()" class="text-blue-600 hover:text-blue-800 text-sm font-medium"><i
                        class="fas fa-sync mr-1"></i> é‡æ–°æ•´ç†</button>
            </div>
            <div id="historyList" class="space-y-4">
                <div class="text-center py-10 text-gray-400">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div id="view-users" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-700">æœƒå“¡åˆ—è¡¨</h2>
                <button onclick="loadUsers()" class="text-blue-600 hover:text-blue-800 text-sm font-medium"><i
                        class="fas fa-sync mr-1"></i> é‡æ–°æ•´ç†</button>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-6 py-3">å¸³è™Ÿ</th>
                            <th class="px-6 py-3">è¨»å†Šæ™‚é–“</th>
                            <th class="px-6 py-3">ç‹€æ…‹</th>
                            <th class="px-6 py-3">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="userListBody">
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // --- é ç±¤åˆ‡æ›é‚è¼¯ ---
        function switchTab(tab) {
            if (tab === 'reports') {
                document.getElementById('view-reports').classList.remove('hidden');
                document.getElementById('view-users').classList.add('hidden');
                document.getElementById('btn-reports').className = "flex-1 py-3 text-center transition-colors tab-active";
                document.getElementById('btn-users').className = "flex-1 py-3 text-center transition-colors tab-inactive";
                loadReports();
            } else {
                document.getElementById('view-reports').classList.add('hidden');
                document.getElementById('view-users').classList.remove('hidden');
                document.getElementById('btn-reports').className = "flex-1 py-3 text-center transition-colors tab-inactive";
                document.getElementById('btn-users').className = "flex-1 py-3 text-center transition-colors tab-active";
                loadUsers();
            }
        }

        // --- 1. æ¡ˆä»¶åŠŸèƒ½ ---
        async function loadReports() {
            try {
                const res = await fetch('/api/reports');
                const data = await res.json();
                const pending = data.filter(r => r.status === 'pending');
                renderReports(pending);
            } catch (e) { alert("æ¡ˆä»¶è¼‰å…¥å¤±æ•—"); }
        }

        function renderReports(reports) {
            const container = document.getElementById('adminList');
            container.innerHTML = '';
            if (reports.length === 0) {
                container.innerHTML = `<div class="bg-white rounded-xl p-8 text-center border border-gray-200 shadow-sm"><p class="text-gray-500">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„æ¡ˆä»¶ ğŸ‰</p></div>`;
                return;
            }
            reports.forEach(r => {
                const html = `
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col sm:flex-row">
                        <div class="w-full sm:w-48 h-48 sm:h-auto bg-gray-100 flex-shrink-0">
                            <img src="${r.imageUrl}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/200?text=No+Image'">
                        </div>
                        <div class="p-5 flex-1 flex flex-col">
                            <div class="flex justify-between items-start mb-2">
                                <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded uppercase">${r.category}</span>
                                <span class="text-xs text-gray-400">${new Date(r.createdAt).toLocaleString()}</span>
                            </div>
                            <h3 class="font-bold text-lg text-gray-800 mb-1">${r.description}</h3>
                            <p class="text-sm text-gray-500 mb-4"><i class="fas fa-map-marker-alt"></i> ${r.latitude.toFixed(5)}, ${r.longitude.toFixed(5)}</p>
                            
                            <div class="mt-auto flex gap-3 pt-4 border-t border-gray-100">
                                <button onclick="updateStatus('${r.id}', 'verified')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-bold transition-colors"><i class="fas fa-check"></i> æ ¸å‡†</button>
                                <button onclick="updateStatus('${r.id}', 'in_progress')" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded-lg text-sm font-bold transition-colors"><i class="fas fa-tools"></i> ç¶­ä¿®</button>
                                <button onclick="updateStatus('${r.id}', 'rejected')" class="flex-1 bg-red-100 hover:bg-red-200 text-red-600 py-2 rounded-lg text-sm font-bold transition-colors"><i class="fas fa-times"></i> é§å›</button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        async function updateStatus(id, status) {
            if (!confirm('ç¢ºå®šè¦æ›´æ–°ç‹€æ…‹å—ï¼Ÿ')) return;
            try {
                await fetch(`/api/reports/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                loadReports();
            } catch (e) { alert("æ›´æ–°å¤±æ•—"); }
        }

        // --- 2. ç”¨æˆ¶ç®¡ç†åŠŸèƒ½ ---
        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users');
                const users = await res.json();
                renderUsers(users);
            } catch (e) { console.error(e); alert("ç”¨æˆ¶åˆ—è¡¨è¼‰å…¥å¤±æ•— (å¯èƒ½æ¬Šé™ä¸è¶³)"); }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('userListBody');
            tbody.innerHTML = '';

            users.forEach(u => {
                // ä¸é¡¯ç¤ºç®¡ç†å“¡è‡ªå·± (333)ï¼Œé¿å…èª¤åˆªè‡ªå·±
                if (u.username === '333') return;

                const isSuspended = u.isSuspended;
                const statusBadge = isSuspended
                    ? `<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded border border-red-200">åœæ¬Šä¸­</span>`
                    : `<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded border border-green-200">æ­£å¸¸</span>`;

                // æ ¹æ“šç‹€æ…‹æ±ºå®šæŒ‰éˆ•
                const btnAction = isSuspended
                    ? `<button onclick="toggleSuspend('${u.id}', 'restore')" class="text-green-600 hover:text-green-900 font-bold border border-green-600 px-3 py-1 rounded text-xs hover:bg-green-50 transition-colors">è§£é™¤åœæ¬Š</button>`
                    : `<button onclick="toggleSuspend('${u.id}', 'suspend')" class="text-red-600 hover:text-red-900 font-bold border border-red-600 px-3 py-1 rounded text-xs hover:bg-red-50 transition-colors">åœæ¬Šå¸³è™Ÿ</button>`;

                const row = `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${u.username}</td>
                        <td class="px-6 py-4">${new Date(u.createdAt).toLocaleDateString()}</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4">${btnAction}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        async function toggleSuspend(userId, action) {
            const msg = action === 'suspend' ? "ç¢ºå®šè¦ã€åœæ¬Šã€‘æ­¤å¸³è™Ÿå—ï¼Ÿä»–å°‡ç„¡æ³•ç™»å…¥ã€‚" : "ç¢ºå®šè¦ã€è§£é™¤åœæ¬Šã€‘å—ï¼Ÿ";
            if (!confirm(msg)) return;

            try {
                const res = await fetch('/api/admin/users/suspend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, action })
                });

                if (res.ok) {
                    alert("æ“ä½œæˆåŠŸï¼");
                    loadUsers(); // é‡æ–°æ•´ç†åˆ—è¡¨
                } else {
                    alert("æ“ä½œå¤±æ•—");
                }
            } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
        }

        // åˆå§‹è¼‰å…¥æ¡ˆä»¶
        loadReports();

        // 1. ä¿®æ”¹ switchTab å‡½å¼ï¼ŒåŠ å…¥ history çš„åˆ¤æ–·
        function switchTab(tab) {
            // éš±è—æ‰€æœ‰è¦–åœ–
            document.getElementById('view-reports').classList.add('hidden');
            document.getElementById('view-users').classList.add('hidden');
            document.getElementById('view-history').classList.add('hidden');

            // é‡ç½®æŒ‰éˆ•æ¨£å¼
            ['reports', 'users', 'history'].forEach(t => {
                document.getElementById(`btn-${t}`).className = "flex-1 py-3 text-center transition-colors tab-inactive";
            });

            // é¡¯ç¤ºé¸ä¸­çš„è¦–åœ–èˆ‡æŒ‰éˆ•
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`btn-${tab}`).className = "flex-1 py-3 text-center transition-colors tab-active";

            if (tab === 'reports') loadReports();
            if (tab === 'users') loadUsers();
            if (tab === 'history') loadHistory(); // æ–°å¢é€™è¡Œ
        }

        // 2. æ–°å¢è®€å–æ­·å²è³‡æ–™çš„åŠŸèƒ½
        async function loadHistory() {
            try {
                const res = await fetch('/api/reports');
                const data = await res.json();
                // ç¯©é¸å‡ºå·²çµæ¡ˆ (completed) çš„æ¡ˆä»¶
                const completed = data.filter(r => r.status === 'completed');
                renderHistory(completed);
            } catch (e) { alert("æ­·å²è³‡æ–™è¼‰å…¥å¤±æ•—"); }
        }

        function renderHistory(reports) {
            const container = document.getElementById('historyList');
            container.innerHTML = '';

            if (reports.length === 0) {
                container.innerHTML = `<div class="bg-white rounded-xl p-8 text-center border border-gray-200 shadow-sm"><p class="text-gray-500">ç›®å‰é‚„æ²’æœ‰å·²çµæ¡ˆçš„ç´€éŒ„</p></div>`;
                return;
            }

            reports.forEach(r => {
                // ç”¢ç”Ÿæ˜Ÿæ˜Ÿ HTML
                let starsHtml = '';
                const rating = r.rating || 0; // å¦‚æœæ²’è©•åˆ†å°±æ˜¯ 0
                for (let i = 1; i <= 5; i++) {
                    if (i <= rating) starsHtml += '<i class="fas fa-star text-yellow-400"></i>';
                    else starsHtml += '<i class="fas fa-star text-gray-200"></i>';
                }

                const feedbackText = r.feedback ? `<div class="mt-3 bg-gray-50 p-3 rounded-lg text-sm text-gray-600"><span class="font-bold text-gray-800">ç”¨æˆ¶å›é¥‹ï¼š</span>${r.feedback}</div>` : `<div class="mt-3 text-xs text-gray-400 italic">ç”¨æˆ¶å°šæœªå¡«å¯«æ–‡å­—å›é¥‹</div>`;

                const html = `
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col sm:flex-row">
                <div class="w-full sm:w-40 h-40 sm:h-auto bg-gray-100 flex-shrink-0 relative">
                    <img src="${r.imageUrl}" class="w-full h-full object-cover">
                    <div class="absolute top-0 left-0 bg-green-500 text-white text-xs px-2 py-1">å·²çµæ¡ˆ</div>
                </div>
                <div class="p-5 flex-1 flex flex-col">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs text-gray-400">${new Date(r.createdAt).toLocaleString()}</span>
                        <div class="flex gap-1 text-sm">${starsHtml}</div>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-1">${r.description}</h3>
                    <p class="text-sm text-gray-500"><i class="fas fa-user-circle"></i> é€šå ±äººï¼š${r.reporter}</p>
                    
                    ${feedbackText}
                </div>
            </div>
        `;
                container.innerHTML += html;
            });
        }
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>æ¡ˆä»¶ç®¡ç†å¾Œå°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .status-new {
            color: red;
            font-weight: bold;
        }

        .status-assigned {
            color: orange;
            font-weight: bold;
        }

        .status-completed {
            color: green;
            font-weight: bold;
        }

        .nav {
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <div class="nav">
        <a href="/">æ°‘çœ¾å ±æ¡ˆ</a> | <a href="/dashboard">å¾Œå°ç®¡ç†</a>
    </div>

    <h1>ğŸ“‹ æ¡ˆä»¶ç®¡ç†å„€è¡¨æ¿</h1>
    <button onclick="loadCases()">é‡æ–°æ•´ç†åˆ—è¡¨</button>

    <table id="casesTable">
        <thead>
            <tr>
                <th>æ—¥æœŸ</th>
                <th>åœ°é»</th>
                <th>æè¿°</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        async function loadCases() {
            const response = await fetch('/cases'); // å‘¼å«æˆ‘å€‘å‰›å‰›å¯«çš„ GET API
            const cases = await response.json();

            const tbody = document.querySelector('#casesTable tbody');
            tbody.innerHTML = ""; // æ¸…ç©ºèˆŠè³‡æ–™

            cases.forEach(c => {
                // è™•ç†æ™‚é–“æ ¼å¼ (å¦‚æœåœ¨ Firebase æ˜¯ Timestamp çš„è©±)
                let dateStr = c.reportTime;

                let row = `
                    <tr>
                        <td>${dateStr}</td>
                        <td>${c.location}</td>
                        <td>${c.description}</td>
                        <td class="status-${c.status.toLowerCase()}">${c.status}</td>
                        <td>
                            ${c.status === 'New' ? `<button onclick="assignTask('${c.id}')">åˆ†æ´¾ä»»å‹™</button>` : ''}
                            ${c.status === 'Assigned' ? `<button onclick="processCase('${c.id}')">å›å ±çµæ¡ˆ</button>` : ''}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // ç°¡å–®å¯¦ä½œï¼šåˆ†æ´¾ä»»å‹™æŒ‰éˆ•åŠŸèƒ½
        async function assignTask(caseId) {
            const unit = prompt("è«‹è¼¸å…¥å°ˆè²¬å–®ä½ ID (ä¾‹å¦‚: Unit_A):", "Unit_Road_Works");
            if (!unit) return;

            const response = await fetch('/assign_task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ caseID: caseId, dedicatedUnitID: unit })
            });
            const res = await response.json();
            if (res.success) { alert("åˆ†æ´¾æˆåŠŸï¼"); loadCases(); }
        }

        // ç°¡å–®å¯¦ä½œï¼šçµæ¡ˆæŒ‰éˆ•åŠŸèƒ½
        async function processCase(caseId) {
            const note = prompt("è«‹è¼¸å…¥è™•ç†çµæœ:", "å·²ä¿®å¾©å®Œæˆ");
            if (!note) return;

            const response = await fetch('/process_case', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ caseID: caseId, progressNotes: "è™•ç†ä¸­", resultDetails: note })
            });
            const res = await response.json();
            if (res.success) { alert("çµæ¡ˆæˆåŠŸï¼"); loadCases(); }
        }

        // ç¶²é è¼‰å…¥æ™‚è‡ªå‹•è®€å–
        window.onload = loadCases;
    </script>
</body>

</html>